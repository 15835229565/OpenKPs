KpWorkflow
=============================

Драйвер KpWorkflow.dll является прикладной библиотекой для приложения Scada Communicator проекта RapidScada.  
Этот драйвер позволяет реализовать управление последовательностью выполнения задач внутри рабочего потока (workflow). При реализации данного проекта использовались следующие библиотеки:  
	- [Wexflow ](https://github.com/aelassas/Wexflow/)  
	- [Mathparser](https://github.com/mariuszgromada/MathParser.org-mXparser)  
	
Вводная информация о работе драйвера KpWorkflow.
--------------------------------------------------------------------------------

Для понимания работы драйвера необходимо дать определение трем основным сущностям, определяющим его работу.  
**Рабочий поток** - это структура описывающая задачи и последовательность их исполнения. Если последовательность исполнения не задана, то задачи описанные внутри рабочего потока выполняются последовательно.  
**Задача** - это некоторый обобщенный алгоритм, для которого могут быть заданы входные и выходные параметры. В базовом виде механизм обмена данными между задачами осуществляется через файлы. В драйвере KpWorkflow добавлен механизм обмена данными через дополнительные объекты в памяти. Этот механизм используется в задачах для которых важна скорость выполнения.  
**Граф выполнения** - это структура, которая описывает последовательность выполнения задач. При описании последовательности выполнения задач могут использоваться конструкции, реализующие условные операторы **if-else**, операторы выбора **switch-case**, оператор цикла **while**, а также реакция на события задач **OnSuccess**, **OnWarning**, **OnError**.  

Примеры построения рабочих потоков.
---------------------------------------------------

При построении рабочих потоков, необходимо ознакомиться с описанием типовых задач. У каждой задачи такое описание содержится в xml файле, совпадающем с именем задачи. В этом файле дается детальное описание используемых параметров задачи при ее конфигурировании.  
Структура файла рабочего потока состоит из 4-х разделов:  
- Корневой раздел - в этом разделе находится описание потока и его идетнификационный номер.
- Заголовочный раздел - в этом разделе находится описание потока и параметры.  
- Раздел описания задач - содержит список задач и их параметры конфигурации.  
- Раздел описания графа исполнения задач - этот раздел содержит описание потокового алгоритма выполнения задач. Если данный раздел отсутствует, то задачи выполняются последовательно.  

Создадим рабочий поток, который ничего полезного не делает, но показывает базовые принципы его построения и конфигурирования.  
Ниже показан пример такого рабочего потока:  

```xml
<Workflow xmlns="urn:wexflow-schema" id="41" name="Workflow_Wait" description="Workflow_Wait">
	<Settings>
		<Setting name="launchType" value="periodic" /> <!-- startup|trigger|periodic -->
		<Setting name="period" value="00.00:00:10.00" />
		<Setting name="enabled" value="true" /> <!-- true|false -->
		<Setting name="createTF" value="false"/> <!-- true|false -->
	</Settings>
	<Tasks>
		<Task id="1" name="Wait" description="Wait for 5 seconds..." enabled="true">
			<Setting name="duration" value="00.00:00:05" />
		</Task>
	</Tasks>
</Workflow>
```
В этом примере рабочий поток запускается каждые 10 секунд. Задача внутри рабочего потока останавливает его выполнение на 5 секунд при каждом запуске.
Структура файла рабочего потока состоит из корневого раздела **Workflow**, заголовочного раздела **Settings** и раздела описания задач **Tasks** .
Корневой раздел **Workflow** содержит три параметра:  
- **id** - определяет уникальный номер рабочего процесса в пределах одного КП. Данный номер используется для управления рабочим потоком по команде из Rapid Scada. В текущем примере данная функциональность не используется, поскольку задействован другой тип запуска рабочего потока.  
- **name** - короткое имя рабочего потока, используется в подсистеме логирования.  
- **description** - в этом параметре можно более детально описать назначение рабочего потока.  

Заголовочный раздел **Settings** содержит четыре параметра:  
  - **launchType** - данный параметр может принимать одно из трех значений:  
    - **startup** - запускает рабочий поток один раз при запуске КП.  
    - **trigger** - запускает рабочий поток по команде из Rapid Scada.  
    - **periodic** - запускает рабочий поток периодически.  
  - **period** - данный параметр используется если значение **launchType** выбрано **periodic**. Определяет период запуска рабочего потока.  
  - **enabled** - данный параметр используется для включения или отключения рабочего потока.  
  - **createTF** - данный параметр определяет, будeт ли рабочий поток создавать временные папки.  


Настройка KpWorkflow драйвера для Scada Communicator.
------------------------------------------------------------------------

Драйвер KpWorkflow зависит от внешних библиотек:
  - **log4net.dll** - данная библиотека используется для реализации внутреннего механизма логирования. При этом файл лога формируется в корневой директории ScadaCommunicator.  
  - **Wexflow.dll** - данная библиотека содержит программный движок, реализующий функциональность Workflow.  
  - **Wexflow.TaskName.dll** - в библиотеках с указанным именем, где **TaskName** имя задачи, содержится программная реализация определенной задачи.  
  
После того как все зависимые библиотеки определены, их необходимо разместить в корневой папке приложения **Scada Communicator**.  
Настроечные параметры **KpWorkflow** задаются в конфигурационном файле формата **xml**, который размещается в папке **Config**.  

Ниже показан пример конфигурационного файла **KpWorkflow**:  

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<Wexflow>
	<Setting name="workflowsFolder" value="C:\SCADA\ScadaComm\Config\KpWorkflow_1\Workflows" />
	<Setting name="tempFolder" value="C:\SCADA\ScadaComm\Config\KpWorkflow_1\Workflow\Temp" />
	<Setting name="xsd" value="C:\SCADA\ScadaComm\Config\KpWorkflow_1\Workflow\Workflow.xsd" />
	<RSServers>
		<RSServer Id="1" ServerHost="xxx.xxx.xxx.xxx" ServerPort="10000" ServerUser="ScadaComm" ServerPwd="12345"/>
		<RSServer Id="2" ServerHost="xxx.xxx.xxx.xxx" ServerPort="10000" ServerUser="ScadaComm" ServerPwd="12345"/>
		<RSServer Id="3" ServerHost="xxx.xxx.xxx.xxx" ServerPort="10000" ServerUser="ScadaComm" ServerPwd="12345"/>
	</RSServers>
</Wexflow>   
```  
где:  
  - **workflowsFolder** - данные параметр содержит путь, где хранятся файлы рабочих потоков.  
  - **tempFolder** - данный параметр содержит путь, где создаются временные файлы рабочих потоков.  
  - **xsd** - данный параметр содержит, путь где находится файл валидации структуры рабочего потока.  
  Секция **RSServers** содержит перечень серверов **RapidScada**, к которым драйвер имеет прямое подключение для взаимодействия из рабочих потоков:   
  - **Id** - **id** сервера **RapidScada**, используется при символьной адресации переменных в конфигурационных файлах соответствующих здач.  
  - **ServerHost** - **IP** адрес **RapidScada** сервера.  
  - **ServerPort** - порт **RapidScada** сервера.  
  - **ServerUser** - имя пользователя на **RapidScada** сервер.  
  - **ServerPwd** - пароль пользователя на **RapidScada** сервер.  




